---
title: "United Airlines Flight Delay Analysis"
author: "Anastasia Nica"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("pivottabler")) install.packages("pivottabler")
library(tidyverse)
library(pivottabler)
```

```{r load-data}
united <- read.csv("United flights.csv")
```

```{r explore}
str(united)
summary(united)
table(united$Origin)
table(united$Origin, united$Destination)
```

```{r feature-engineering}
df <- united %>%
  mutate(
    Total_Delay = Arrival_Delay + Departure_Delay,
    Net_Delay = Arrival_Delay - Departure_Delay,
    factor_rain_at_origin = ifelse(Rain_at_Origin == 1, "Rain", "No Rain"),
    factor_incentive_pay = ifelse(Incentive_Pay == 1, "With Incentive", "No Incentive")
  )
```

```{r subsets}
cancelled_flights <- df %>% filter(Cancelled == 1)
recovered_delay <- df %>% filter(Arrival_Delay <= 0 & Departure_Delay > 0)
```

```{r pivot-table}
qpvt(df, "factor_incentive_pay", "factor_rain_at_origin", 
     "sum(Departure_Delay, na.rm=TRUE)")

qhpvt(df, "factor_incentive_pay", "factor_rain_at_origin",
      calculations = list(
        "Total Departure Delay" = "sum(Departure_Delay, na.rm=TRUE)",
        "Mean Departure Delay" = "mean(Departure_Delay, na.rm=TRUE)"
      ),
      formats = list("%.0f", "%.2f"))
```

```{r histogram-departure}
ggplot(df, aes(x = Departure_Delay)) +
  geom_histogram(binwidth = 10, fill = "steelblue", colour = "black") +
  theme_minimal() +
  labs(title = "Histogram of Departure Delays", x = "Departure Delay (minutes)", y = "Count")
```

```{r histogram-arrival}
ggplot(df, aes(x = Arrival_Delay)) +
  geom_histogram(binwidth = 10, fill = "darkgreen", colour = "black") +
  theme_minimal() +
  labs(title = "Histogram of Arrival Delays", x = "Arrival Delay (minutes)", y = "Count")
```

```{r scatter-plot}
ggplot(df, aes(x = Departure_Delay, y = Arrival_Delay, colour = factor_rain_at_origin)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Scatter Plot of Departure vs Arrival Delay")
```

```{r boxplot}
ggplot(df, aes(x = Origin, y = Net_Delay)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(title = "Boxplot of Net Delay by Origin")
```

```{r pivot-plot}
pt <- qpvt(df, "Destination", "Origin", c("mean_" = "mean(Net_Delay, na.rm=TRUE)"))
pt_df <- pt$asTidyDataFrame()

clean_pt <- pt_df %>% 
  filter(isTotal == FALSE, !is.na(formattedValue))

ggplot(clean_pt, aes(x = Origin, y = Destination)) +
  geom_point(aes(size = as.numeric(rawValue)), colour = "darkred", alpha = 0.6) +
  theme_minimal() +
  labs(title = "Mean Net Delay by Origin and Destination", size = "Mean Net Delay")
```

```{r export-data, eval=FALSE}
write.csv(df, "United_Cleaned.csv", row.names = FALSE)
```

```{r clear, eval=FALSE}
rm(list = ls())
```
