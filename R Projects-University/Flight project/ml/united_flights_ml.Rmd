---
title: "United Airlines Delay Prediction with ML"
author: "Anastasia Nica"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## 📦 Load Libraries
```{r packages}
if(!require("tidymodels")) install.packages("tidymodels")
if(!require("rpart.plot")) install.packages("rpart.plot")
if(!require("randomForest")) install.packages("randomForest")
if(!require("lubridate")) install.packages("lubridate")
library(tidyverse)
library(tidymodels)
library(rpart.plot)
library(randomForest)
library(lubridate)
```

## 📂 Load and Prepare Data
```{r load}
df <- read.csv("United flights.csv")

# Feature Engineering
df <- df %>%
  mutate(
    Total_Delay = Arrival_Delay + Departure_Delay,
    Delay_Category = case_when(
      Total_Delay <= 0 ~ "On Time",
      Total_Delay <= 30 ~ "Mild",
      Total_Delay <= 120 ~ "Moderate",
      TRUE ~ "Severe"
    ),
    Cancelled = factor(Cancelled, levels = c(0, 1), labels = c("No", "Yes")),
    factor_rain_origin = factor(ifelse(Rain_at_Origin == 1, "Rain", "No Rain")),
    factor_incentive = factor(ifelse(Incentive_Pay == 1, "Yes", "No")),
    Time_in_Air = ifelse(is.na(Time_in_Air), median(Time_in_Air, na.rm = TRUE), Time_in_Air)
  ) %>%
  drop_na(Total_Delay)
```

## ✂️ Data Split
```{r split}
set.seed(42)
split <- initial_split(df, prop = 0.8, strata = Delay_Category)
train <- training(split)
test <- testing(split)
```

## 🛠️ Preprocessing Recipe
```{r recipe}
rec <- recipe(Delay_Category ~ Origin + Destination + factor_rain_origin + factor_incentive + Time_in_Air + Cancelled,
              data = train) %>%
  step_dummy(all_nominal_predictors())
```

## 🌳 Decision Tree Model
```{r tree-model}
mod_tree <- decision_tree(mode = "classification") %>%
  set_engine("rpart")

wf_tree <- workflow() %>%
  add_model(mod_tree) %>%
  add_recipe(rec)

fit_tree <- fit(wf_tree, data = train)
```

## 📊 Visualise Decision Tree
```{r tree-viz}
fit_tree %>%
  extract_fit_engine() %>%
  rpart.plot(main = "Decision Tree: Delay Severity")
```

## 🌲 Random Forest Model
```{r rf-model}
mod_rf <- rand_forest(mtry = 4, trees = 300, min_n = 5) %>%
  set_engine("randomForest") %>%
  set_mode("classification")

wf_rf <- workflow() %>%
  add_model(mod_rf) %>%
  add_recipe(rec)

fit_rf <- fit(wf_rf, data = train)
```

## 📈 Evaluate Models
```{r predictions}
# Tree
pred_tree <- predict(fit_tree, test) %>% bind_cols(test)
# Forest
pred_rf <- predict(fit_rf, test) %>% bind_cols(test)

# Accuracy Comparison
bind_rows(
  metrics(pred_tree, truth = Delay_Category, estimate = .pred_class) %>% mutate(model = "Tree"),
  metrics(pred_rf, truth = Delay_Category, estimate = .pred_class) %>% mutate(model = "Random Forest")
) %>% filter(.metric == "accuracy")
```

## 🔥 Confusion Matrix: Random Forest
```{r rf-conf}
conf_mat(pred_rf, truth = Delay_Category, estimate = .pred_class) %>%
  autoplot(type = "heatmap") + labs(title = "Random Forest Confusion Matrix")
```

## 📌 Export Model (optional)
```{r save-model, eval=FALSE}
saveRDS(fit_rf, "delay_rf_model.rds")
saveRDS(fit_tree, "delay_tree_model.rds")
```
